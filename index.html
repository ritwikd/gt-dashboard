
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.5.4/bootstrap-select.css">
    <link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="web/css/index.css">
    <link rel="stylesheet" type="text/css" href="web/css/vex.css">
    <link rel="stylesheet" type="text/css" href="web/css/vex-theme-os.css">
    <link rel="stylesheet" type="text/css" href="web/css/select-theme-default.css">
    <style type="text/css">

    </style>   
        
  </head>

  <body>

    <div class="topbar">
        <div class = "title">GT Health Dashboard</div>
    </div>
    
    <div class = "sel">
      <div class="inst">
        Login
      </div>
      <div class="dropdown">
        <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
          Choose user
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
        </ul>
      </div>
    </div>

    <img class="logo" src="web/assets/back.png">
    <div class="controls container">
      <div class="controls add" onclick="javascript: addUser();">
        <i class="fa fa-plus"></i><i class="fa fa-user"></i>  
      </div>

      <div class="controls delete" onclick="javascript: deleteUser();">
        <i class="fa fa-times"></i><i class="fa fa-user"></i>  
      </div>
    </div>
    
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="web/js/vex.combined.min.js"></script>
    <script src="web/js/select.min.js"></script>
    <script type="text/javascript">

      var userLinkTemplate = ['<li role="presentation"><a class = "link" data-user="',
        '" role="menuitem" tabindex="-1" href="#" onclick="javascript: dash(this);">',
        '</a></li>'];

      var userCreateURLTemplate = 'http://vps.ritwikd.com:8081/winstonsmith?type=create&fullname=';
      var userDeleteURLTemplate = ['http://vps.ritwikd.com:8081/', '?type=delete'];

      var userCreateURL = "";
      var userCreateUsername = "";

      var userList = $.parseJSON($.ajax({
          type: "GET",
          url: "http://vps.ritwikd.com:8081/winstonsmith?type=users",
          async: false
      }).responseText);

      var userDeleteURL = "";
      var userDeleteUsername = "";
      var deleteUserTemplate = ['<div class="selectbox"><select>','</div>'];


      $.each(userList, function(userName) {
        $(".dropdown-menu").append( userLinkTemplate[0] + 
            userName + userLinkTemplate[1] + 
            userList[userName] + userLinkTemplate[2]
          );
        deleteUserTemplate[0] += '<option data-username="' +
          userName + '">' +
          userList[userName] + '</option>';
      });

      $(".link").on('click', function()  {
          localStorage.setItem('username', $(this).attr('data-user'));
          window.location = "dash.html";
        });

      vex.defaultOptions.className = 'vex-theme-os';

      function addUser() {
        vex.dialog.prompt({
          message: 'Enter full name for new user:',
          placeholder: 'Winston Smith',
          callback: function(userCreateRequestName) {
            return userCreateUsername = userCreateRequestName;
          },
          afterClose: function() {
            makeCreateUserRequest(userCreateUsername);
          }
        });
      };

      function deleteUser() {
        vex.dialog.open({
          message: 'Select a user to delete:',
          input: deleteUserTemplate[0] + deleteUserTemplate[1],
          callback: function(data) {
            return userDeleteUsername = $(".selectbox option:selected").attr('data-username')
          }, 
          afterClose: function() {
              makeDeleteUserRequest(userDeleteUsername);
          }
        });

        Select.init();

      }

      function makeCreateUserRequest(userCreateUsername) {
        userCreateUsername = userCreateUsername.replace(" ", "%20").replace(".", "%2E");
        userCreateUsername = userCreateUsername.replace("-", "%2D");
        userCreateURL = userCreateURLTemplate +
            userCreateUsername;

        var userCreateUserRequest = $.ajax({
          type: "GET", 
          url : userCreateURL, 
          async : false
        }).responseText;

        var userList = $.parseJSON($.ajax({
            type: "GET",
            url: "http://vps.ritwikd.com:8081/winstonsmith?type=users",
            async: false
        }).responseText);

        $(".dropdown-menu").html('<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">');
        deleteUserTemplate = ['<div class="selectbox"><select>','</div>'];

        $.each(userList, function(userName) {
          $(".dropdown-menu").append( userLinkTemplate[0] + 
              userName + userLinkTemplate[1] + 
              userList[userName] + userLinkTemplate[2]
            );
          deleteUserTemplate[0] += '<option data-username="' +
          userName + '">' +
          userList[userName] + '</option>';
        });

        $(".link").on('click', function()  {
          localStorage.setItem('username', $(this).attr('data-user'));
          window.location = "dash.html";
        });

      }

      function makeDeleteUserRequest(userDeleteUsername) {
        userDeleteURL = userDeleteURLTemplate[0] + 
            userDeleteUsername + 
            userDeleteURLTemplate[1];
        
        var userCreateDeleteRequest = $.ajax({
          type: "GET", 
          url : userDeleteURL, 
          async : false
        }).responseText;

        var userList = $.parseJSON($.ajax({
            type: "GET",
            url: "http://vps.ritwikd.com:8081/winstonsmith?type=users",
            async: false
        }).responseText);

        $(".dropdown-menu").html('<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">');
        deleteUserTemplate = ['<div class="selectbox"><select>','</div>'];

        $.each(userList, function(userName) {
          $(".dropdown-menu").append( userLinkTemplate[0] + 
              userName + userLinkTemplate[1] + 
              userList[userName] + userLinkTemplate[2]
            );
          deleteUserTemplate[0] += '<option data-username="' +
          userName + '">' +
          userList[userName] + '</option>';
        });

        $(".link").on('click', function()  {
          localStorage.setItem('username', $(this).attr('data-user'));
          window.location = "dash.html";
        });

      }

    </script>   

  </body>

</html>